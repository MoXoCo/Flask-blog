<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>主页</title>
    <script src="http://cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script>
    <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
    <script id="id-template-post" type="text/x-jquery-tmpl">
        <h4>
            ${ timestamp }
            <br>
            <a href="/user/${username}">${username}: </a>${ content }
            <a href="/post/update/${id}">编辑</a>
            <button class='id-button-delete'
                    data-id='${ id }'
                    data-name='${ username }'
                    >删除</button>
        </h4>
    </script>
    <script>
        var bindAddPostAction = function(){
            var button = $('#id-button-submit');
            button.on('click', function(){
                // console.log('click')
                var post = $('#id-textarea-post').val();
                console.log('post: ', post);
                var form = {
                    content: post,
                };
                var url = '/post/edit'
                var data = JSON.stringify(form)
                var request = {
                    url: url,
                    type: 'post',
                    data: data,
                    contentType: 'application/json',
                    success: function(data){
                        console.log('服务器返回了： ',typeof data, data);
                        console.log('成功添加微博！');
                        $('#id-template-post').tmpl(data).insertAfter('#id-h1-add')
                    }
                };
                $.ajax(request);
            })
        }

            var bindDeleteAction = function(){
                $('body').on('click', '.id-button-delete', function(){
                    var self = $(this);
                    var post_id = this.dataset.id;
                    var name = this.dataset.name;
                    console.log('post ',post_id, name);
                    var request = {
                        url: '/post/delete/' + post_id,
                        type: 'get',
                        success: function(data){
                            console.log('成功删除 ',post_id)
                            console.log('data: ',data);
                            if(data.success){
                                self.parent().remove();
                            }
                        }
                    };
                    $.ajax(request);
                });
            }


            $(document).ready(function(){
                bindDeleteAction();
                bindAddPostAction();
            });

    </script>
</head>
<body>
    {% for flash in get_flashed_messages() %}
        <p>{{ flash }}</p>
    {% endfor %}
    <br>
    <textarea id="id-textarea-post"></textarea>
    <br>
    <button id="id-button-submit">Submit</button>
    <hr>
    <h1 id='id-h1-add'>Posts</h1>
    {% for post in posts %}
        <h4>
            {% if not post.is_delete %}
                {{ post.timestamp }}
                <br>
                <a href="/user/{{post.user.username}}">{{ post.user.username}}: </a>{{ post.content }}
                {% if user.id == post.user_id or user.is_admin() %}
                    <a href="/post/update/{{post.id}}">编辑</a>
                    <button class='id-button-delete'
                            data-id='{{ post.id }}'
                            data-name='{{ post.user.username }}'
                            >删除</button>
                {% endif %}
                <a href="/post/{{post.id}}">{{ post.comments.count()}}条评论</a>
            {% endif %}
        </h4>
    {% endfor %}

</body>
</html>
